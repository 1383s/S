<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Full Mark Player - Ultra Fix</title>
  
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="auth.js"></script>
<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

<style>
  @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700;800;900&display=swap');

  :root { --dark-black: #020A07; --neon-accent: #27d97e; --success: #00C896; --light-text: #f0f0f5; }
  body { font-family: 'Cairo', sans-serif; background: #000; color: var(--light-text); margin: 0; text-align: center; }

  .topbar {
    display: flex; align-items: center; justify-content: space-between;
    background: rgba(8, 64, 44, 0.4); backdrop-filter: blur(5px);
    padding: 14px 18px; border-bottom: 2px solid var(--neon-accent);
  }

  .player-container {
    max-width: 950px; width: 100%; margin: 20px auto; position: relative;
    border-radius: 15px; overflow: hidden; background: #000;
    touch-action: none; /* Ù„Ù…Ù†Ø¹ Ø§Ù„Ø²ÙˆÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
  }

  #player { width: 100%; height: 60vh; }

  /* Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ù…Ø³Ø¦ÙˆÙ„Ø© Ø¹Ù† Ø§Ù„Ù„Ù…Ø³ ÙÙ‚Ø· */
  #touch-handler {
    position: absolute; top: 0; left: 0; width: 100%; height: calc(100% - 60px);
    z-index: 10; cursor: pointer;
  }

  .video-feedback {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    background: rgba(39, 217, 126, 0.9); color: #000; padding: 12px 25px;
    border-radius: 30px; font-weight: bold; z-index: 20; display: none; pointer-events: none;
    font-family: 'Orbitron', sans-serif;
  }

  .notes-container { max-width: 950px; width: 92%; margin: 20px auto; padding: 20px; background: #0C241C; border-radius: 15px; text-align: right; }
  #video-notes { width: 100%; min-height: 150px; background: #020A07; color: #fff; border: 2px solid var(--neon-accent); border-radius: 10px; padding: 15px; box-sizing: border-box; outline: none; }
</style>
</head>
<body>

<div class="topbar">
  <div class="back" onclick="history.back()">â¬…</div>
  <div class="title">ğ‘·ğ’ğ’‚ğ’š ğ‘½ğ’Šğ’…ğ’†ğ’</div>
  <div style="width:25px;"></div>
</div>

<div class="player-container" id="main-container">
    <div id="touch-handler"></div>
    <video id="player" playsinline controls></video>
    <div id="feedback" class="video-feedback"></div>
</div>

<div class="notes-container">
  <h2>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙŠ</h2>
  <textarea id="video-notes" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ù‡Ù†Ø§..."></textarea>
  <div id="save-status" style="color: var(--success); opacity:0; transition:0.5s;">âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸</div>
</div>

<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<script>
const video = document.getElementById('player');
const touchHandler = document.getElementById('touch-handler');
const feedback = document.getElementById('feedback');

// ØªØ´ØºÙŠÙ„ Plyr Ù…Ø¹ ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ÙƒÙ„ÙŠÙƒ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
const player = new Plyr('#player', {
    controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'settings', 'fullscreen'],
    clickToPlay: false 
});

let timer = null;
let longPressTimer = null;
let isLongPress = false;

function showMsg(txt) {
    feedback.textContent = txt;
    feedback.style.display = 'block';
    setTimeout(() => feedback.style.display = 'none', 800);
}

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù„Ù…Ø³ (Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙˆÙƒÙ…Ø¨ÙŠÙˆØªØ±)
function onTouchStart(e) {
    e.preventDefault();
    const rect = touchHandler.getBoundingClientRect();
    const clientX = e.clientX || e.touches[0].clientX;
    const x = clientX - rect.left;
    const isRight = x > rect.width / 2;

    // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¶ØºØ·Ø© Ø§Ù„Ù…Ø·ÙˆÙ„Ø©
    longPressTimer = setTimeout(() => {
        isLongPress = true;
        video.playbackRate = 2.0;
        showMsg("â© 2x Speed");
    }, 500);

    // Ø§Ù„ÙƒØ´Ù Ø¹Ù† Double Click
    if (e.detail === 2 || (timer !== null)) {
        // Double Click
        clearTimeout(timer);
        clearTimeout(longPressTimer);
        timer = null;
        if (isRight) {
            video.currentTime += 10;
            showMsg("+10s");
        } else {
            video.currentTime -= 10;
            showMsg("-10s");
        }
    } else {
        // Single Click (Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯)
        timer = setTimeout(() => {
            if (!isLongPress) {
                if (video.paused) video.play(); else video.pause();
            }
            timer = null;
        }, 300);
    }
}

function onTouchEnd() {
    clearTimeout(longPressTimer);
    if (isLongPress) {
        video.playbackRate = 1.0;
        isLongPress = false;
        showMsg("1x Speed");
    }
}

// Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
touchHandler.addEventListener('mousedown', onTouchStart);
touchHandler.addEventListener('mouseup', onTouchEnd);
touchHandler.addEventListener('touchstart', onTouchStart, {passive: false});
touchHandler.addEventListener('touchend', onTouchEnd);

// ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ HLS
const savedSources = localStorage.getItem("video_sources");
if (savedSources) {
    try {
        const links = JSON.parse(savedSources);
        const url = Array.isArray(links) ? (links[0].url || links[0]) : (links.url || links);
        if (Hls.isSupported()) {
            const hls = new Hls();
            hls.loadSource(url);
            hls.attachMedia(video);
        } else {
            video.src = url;
        }
    } catch(e) { console.error("URL Error"); }
}

// Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
const videoID = btoa(window.location.href);
const notes = document.getElementById('video-notes');
notes.value = localStorage.getItem(`n_${videoID}`) || "";
notes.oninput = () => {
    localStorage.setItem(`n_${videoID}`, notes.value);
    document.getElementById('save-status').style.opacity = 1;
    setTimeout(() => document.getElementById('save-status').style.opacity = 0, 1000);
};
</script>
</body>
</html>
