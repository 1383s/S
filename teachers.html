<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نخبة المدرسين | Teachers</title>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js"></script>
    <script type="module" src="devcheck.js"></script>
    <script src="auth.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* =========================================
           نفس تصميم النيون الاحترافي (CSS)
           ========================================= */
        body { 
            background-color: #020617; 
            color: white; 
            font-family: 'Tajawal', sans-serif; 
            min-height: 100vh; 
            overflow-x: hidden; 
            padding-bottom: 50px;
        }

        /* خلفية نيون */
        .bg-glow {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(circle at 50% -10%, #1e1b4b, #020617 70%);
        }

        /* كارت المدرس الاحترافي */
        .pro-card {
            background: rgba(30, 41, 59, 0.4);
            border: 1px solid rgba(99, 102, 241, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 28px;
            padding: 35px 20px;
            display: flex; flex-direction: column; align-items: center;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative; overflow: hidden;
            cursor: pointer;
        }

        .pro-card:hover {
            transform: translateY(-12px);
            background: rgba(30, 41, 59, 0.6);
            border-color: #6366f1;
            box-shadow: 0 25px 50px -12px rgba(99, 102, 241, 0.25);
        }

        /* دائرة الصورة */
        .img-ring {
            width: 120px; height: 120px;
            border-radius: 50%;
            padding: 4px;
            background: linear-gradient(135deg, #6366f1, #a855f7, #d946ef);
            box-shadow: 0 0 25px rgba(99, 102, 241, 0.3);
            margin-bottom: 22px;
            transition: 0.5s;
        }
        .pro-card:hover .img-ring { transform: rotate(5deg) scale(1.05); box-shadow: 0 0 35px rgba(217, 70, 239, 0.5); }

        .teacher-img {
            width: 100%; height: 100%; border-radius: 50%;
            object-fit: cover; border: 4px solid #0f172a;
            background: #1e293b;
        }

        .t-name { font-size: 1.5rem; font-weight: 800; color: white; margin-bottom: 8px; text-align: center; }
        
        /* شارة المعلومات */
        .info-badge {
            background: rgba(99, 102, 241, 0.1); color: #c7d2fe;
            padding: 8px 18px; border-radius: 50px; font-size: 0.8rem;
            font-weight: bold; border: 1px solid rgba(99, 102, 241, 0.2);
            display: flex; align-items: center; gap: 8px;
        }

        .arrow-btn {
            position: absolute; bottom: 20px; left: 20px;
            width: 45px; height: 45px; border-radius: 18px;
            background: linear-gradient(135deg, #6366f1, #a855f7); 
            color: white; display: flex; align-items: center; justify-content: center;
            opacity: 0; transform: translateX(20px); transition: 0.4s;
            box-shadow: 0 10px 15px rgba(99, 102, 241, 0.3);
        }
        .pro-card:hover .arrow-btn { opacity: 1; transform: translateX(0); }
        
        /* شاشة التحميل */
        .loading-overlay {
            position: fixed; inset: 0; z-index: 50; 
            background: rgba(2, 6, 23, 0.9); 
            backdrop-filter: blur(10px);
            display:flex; justify-content:center; align-items:center; flex-direction:column;
        }

        /* التنبيهات */
        .toast {
            min-width:200px; max-width:300px; padding:12px 20px; 
            border-radius:12px; color:white; font-weight:bold; 
            box-shadow:0 10px 30px rgba(0,0,0,0.5);
            display: flex; align-items: center; gap: 10px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .toast.info { background-color: #1e293b; border-color: #6366f1; color: #818cf8; } 
        .toast.success { background-color: #064e3b; border-color: #10b981; color: #34d399; }
        .toast.error { background-color: #450a0a; border-color: #ef4444; color: #fca5a5; }
        
        .toast-enter-active, .toast-leave-active { transition: all 0.3s ease; }
        .toast-enter-from, .toast-leave-to { opacity:0; transform: translateY(20px); }
    </style>
</head>

<body>
    <div class="bg-glow"></div>

    <div id="app" class="p-6 max-w-7xl mx-auto min-h-screen flex flex-col">
        
        <div class="flex items-center justify-between mb-12 animate-fade-in">
            <div class="flex items-center gap-5">
                <a href="subjects.html" class="w-14 h-14 bg-white/5 border border-white/10 rounded-2xl text-white hover:bg-white/10 transition-all flex items-center justify-center group cursor-pointer">
                    <i class="fas fa-chevron-right text-lg group-hover:translate-x-1 transition-transform"></i>
                </a>
                <div>
                    <h1 class="text-3xl md:text-4xl font-black tracking-tight text-transparent bg-clip-text bg-gradient-to-l from-white via-indigo-200 to-indigo-400">
                        {{ subjectData.name || 'جاري التحميل...' }}
                    </h1>
                    <p class="text-gray-400 text-sm mt-1 flex items-center gap-2">
                        <span class="w-2 h-2 bg-indigo-500 rounded-full animate-ping"></span>
                        مدرسين {{ yearData.name }}
                    </p>
                </div>
            </div>
        </div>

        <div v-if="loading" class="loading-overlay">
            <i class="fas fa-circle-notch fa-spin text-5xl mb-4 text-indigo-500"></i>
            <p class="text-lg text-indigo-200">جاري جلب نخبة المعلمين...</p>
        </div>

        <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 pb-10">
            
            <div v-for="teacher in teachers" :key="teacher.id" @click="selectTeacher(teacher)" class="pro-card group">
                
                <div class="img-ring">
                    <img :src="teacher.image_url || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png'" 
                         class="teacher-img" 
                         onerror="this.src='https://cdn-icons-png.flaticon.com/512/3135/3135715.png'">
                </div>

                <h2 class="t-name group-hover:text-indigo-400 transition-colors">{{ teacher.name }}</h2>
                
                <div class="info-badge">
                    <i class="fas fa-layer-group text-indigo-400"></i>
                    <span>{{ teacher.chapter_count || 0 }} وحدات متاحة</span>
                </div>

                <div class="arrow-btn">
                    <i class="fas fa-arrow-left"></i>
                </div>
            </div>

            <div v-if="!teachers.length && !loading" class="col-span-full text-center py-20 border-2 border-dashed border-white/5 rounded-[40px]">
                <div class="bg-indigo-500/10 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="fas fa-user-slash text-4xl text-indigo-500 opacity-50"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-300">لا يوجد مدرسين</h3>
                <p class="text-gray-500 mt-2">لم يتم إضافة مدرسين لهذه المادة حتى الآن.</p>
            </div>

        </div>

        <div class="fixed bottom-4 right-4 flex flex-col gap-2 z-50">
            <transition-group name="toast">
                <div v-for="toast in toasts" :key="toast.id" :class="['toast', toast.type]">
                    <i class="fas" :class="toast.type === 'success' ? 'fa-check-circle' : (toast.type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle')"></i>
                    {{ toast.message }}
                </div>
            </transition-group>
        </div>

    </div>

    <script>
    /* =========================================
       نفس كود الجافاسكريبت الخاص بملفك الأصلي
       ========================================= */
    const { createApp, ref, reactive } = Vue;

    // ** الـ Object اللي بيربط الشعبة بالـ URL بتاعها **
    const JSON_URLS = {
        'علمي علوم': "https://plus-teal.vercel.app/organized_output.json",
        'أدبي': "https://plus-teal.vercel.app/organized_output-a.json", 
        'علمي رياضة': "https://platform-sigma-seven.vercel.app/organized_output-e.json", 
        'أزهر': "https://plus-teal.vercel.app/organized_output.json", 
        'الافتراضي': "https://plus-teal.vercel.app/organized_output.json"
    };

    // دالة مساعده لقراءة الـ Parameters من الـ URL
    function getUrlParams() {
        const params = {};
        window.location.search.substring(1).split('&').forEach(pair => {
            const [key, value] = pair.split('=');
            if (key && value) params[key] = decodeURIComponent(value);
        });
        return params;
    }

    createApp({
        setup() {
            const loading = ref(true);
            const teachers = ref([]);
            const params = getUrlParams();
            
            // بيانات مؤقتة بيتم تحديثها بعد جلب البيانات
            const yearData = reactive({ name: 'السنة الدراسية', id: params.yid || null });
            const subjectData = reactive({ name: 'المادة', id: params.sid || null });

            let studentDivision = null; 
            const STUDENT_CODE_KEY = "activeCode"; 

            const db = firebase.database(); 

            // Toasts
            const toasts = ref([]);
            const showToast = (message, type='info', duration=3000) => {
                const id = Date.now() + Math.random();
                toasts.value.push({ id, message, type });
                setTimeout(() => {
                    const index = toasts.value.findIndex(t => t.id === id);
                    if(index !== -1) toasts.value.splice(index,1);
                }, duration);
            };
            
            // الانتقال لصفحة الشباتر
            const selectTeacher = (teacher) => {
                if (!yearData.id || !subjectData.id) {
                    showToast("خطأ في بيانات التوجيه.", "error");
                    return;
                }
                const url = `chapters.html?yid=${yearData.id}&sid=${subjectData.id}&tid=${teacher.id}`;
                window.location.href = url;
            }

            // جلب البيانات بناءً على الـ IDs اللي في الـ URL والشعبة
            const fetchData = async () => {
                if (!params.yid || !params.sid) {
                    loading.value = false;
                    showToast("خطأ: رابط الصفحة غير مكتمل (YID/SID).", "error");
                    return;
                }

                // 1. قراءة الـ activeCode
                const activeCode = localStorage.getItem(STUDENT_CODE_KEY);
                if (!activeCode) {
                    loading.value = false;
                    showToast("يجب تسجيل الدخول أولاً.", "error");
                    return;
                }

                try {
                    // 2. جلب الشعبة من Firebase
                    const snapshot = await db.ref(`approvedStudents/${activeCode}`).once('value');
                    const studentData = snapshot.val();
                    
                    if (studentData && studentData.section) {
                        studentDivision = studentData.section.trim();
                    } else {
                        studentDivision = 'الافتراضي';
                    }

                    // 4. تحديد مصدر البيانات
                    const dynamicDataUrl = JSON_URLS[studentDivision] || JSON_URLS['الافتراضي'];

                    // 5. استكمال جلب البيانات
                    const res = await fetch(dynamicDataUrl); 
                    
                    if (!res.ok) throw new Error(`فشل تحميل البيانات للشعبة: ${studentDivision}`);
                    const fullData = await res.json();

                    // 6. البحث عن السنة
                    const year = fullData.find(y => y.id == params.yid);
                    if (!year) throw new Error("السنة الدراسية غير موجودة");
                    yearData.name = year.name; 

                    // 7. البحث عن المادة داخل السنة
                    const subject = year.subjects.find(s => s.id == params.sid);
                    if (!subject) throw new Error("المادة غير موجودة");
                    subjectData.name = subject.name; 
                    
                    // 8. عرض المُعلّمين
                    teachers.value = subject.teachers || [];
                    
                    // showToast(`تم تحميل ${teachers.value.length} معلم (${studentDivision}).`, "success");

                } catch (err) {
                    console.error("Data fetching error:", err);
                    showToast(`خطأ في التحميل: ${err.message}`, "error");
                } finally {
                    loading.value = false;
                }
            }

            fetchData();

            return { loading, teachers, yearData, subjectData, selectTeacher, toasts };
        }
    }).mount('#app');
    </script>
</body>
</html>
